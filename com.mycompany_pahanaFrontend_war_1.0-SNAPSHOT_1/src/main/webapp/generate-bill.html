<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pahana Edu - Generate Invoice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    @media print {
      body * {
        visibility: hidden;
      }
      #bill-section, #bill-section * {
        visibility: visible;
      }
      #bill-section {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }
      .print\:hidden {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-gray-100 p-6 font-sans">

<div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6" id="bill-section">
  <h1 class="text-2xl font-bold text-center mb-6">ğŸ“„ Generate Bill</h1>

  <!-- Customer Selection -->
  <div class="mb-4">
    <label class="block font-semibold mb-1">ğŸ‘¤ Select Customer</label>
    <select id="customerSelect" class="w-full p-2 border rounded" onchange="updateCustomerDetails()"></select>
    <div id="customerDetails" class="text-sm text-gray-700 mt-2"></div>
  </div>

  <!-- Item Selection -->
  <div class="mb-4">
    <label class="block font-semibold mb-1">ğŸ“¦ Select Item</label>
    <div class="flex space-x-2">
      <select id="itemSelect" class="flex-grow p-2 border rounded" onchange="updateItemDetails()"></select>
      <input type="number" id="itemQty" placeholder="Qty" min="1" class="w-24 p-2 border rounded" />
      <button onclick="addItem()" class="bg-blue-500 text-white px-4 rounded print:hidden">Add</button>
    </div>
    <div id="itemDetails" class="text-sm text-gray-700 mt-2"></div>
  </div>

  <!-- Bill Item List -->
  <div class="mb-4">
    <label class="block font-semibold mb-1">ğŸ§¾ Items in Bill</label>
    <ul id="billItems" class="border p-2 rounded mt-1 space-y-2"></ul>
  </div>

  <!-- Total Amount -->
  <div class="text-right text-xl font-bold mb-4">
    Total: Rs. <span id="totalAmount">0.00</span>
  </div>

  <!-- Action Buttons -->
  <div class="flex justify-between print:hidden">
    <button onclick="saveBill()" class="bg-green-600 text-white px-4 py-2 rounded">ğŸ’¾ Save Bill</button>
    <button onclick="printBill()" class="bg-gray-700 text-white px-4 py-2 rounded">ğŸ–¨ï¸ Print</button>
    <button onclick="downloadPDF()" class="bg-red-600 text-white px-4 py-2 rounded">â¬‡ï¸ Download PDF</button>
  </div>
  
  
</div>

<script>
const API_CUSTOMERS = "http://localhost:8080/pahanaBackend/resources/customers";
const API_ITEMS = "http://localhost:8080/pahanaBackend/resources/items";

let customers = [];
let items = [];
let bill = [];

async function loadData() {
  try {
    customers = await fetch(API_CUSTOMERS).then(res => res.json());
    items = await fetch(API_ITEMS).then(res => res.json());

    const customerSelect = document.getElementById("customerSelect");
    const itemSelect = document.getElementById("itemSelect");

    customers.forEach(c => {
      const option = document.createElement("option");
      option.value = c.accountNumber;
      option.textContent = `${c.name} (${c.accountNumber})`;
      customerSelect.appendChild(option);
    });

    items.forEach(i => {
      const option = document.createElement("option");
      option.value = i.id;
      option.textContent = `${i.name} (Rs.${i.price})`;
      itemSelect.appendChild(option);
    });

    updateCustomerDetails();
    updateItemDetails();
  } catch (err) {
    alert("Error loading data. Check API.");
    console.error(err);
  }
}

function updateCustomerDetails() {
  const selectedId = document.getElementById("customerSelect").value;
  const customer = customers.find(c => c.accountNumber == selectedId);
  if (customer) {
    document.getElementById("customerDetails").innerHTML = `
      <div>ğŸ“ Address: ${customer.address}</div>
      <div>ğŸ“ Telephone: ${customer.telephone}</div>
      <div>ğŸ“§ Email: ${customer.email || '-'}</div>
    `;
  }
}

function updateItemDetails() {
  const selectedId = document.getElementById("itemSelect").value;
  const item = items.find(i => i.id == selectedId);
  if (item) {
    document.getElementById("itemDetails").innerHTML = `
      <div>ğŸ“‚ Category: ${item.category}</div>
      <div>ğŸ“¦ Available: ${item.quantity}</div>
    `;
  }
}

function addItem() {
  const itemId = document.getElementById("itemSelect").value;
  const qty = parseInt(document.getElementById("itemQty").value);
  const item = items.find(i => i.id == itemId);

  if (!item || isNaN(qty) || qty <= 0) {
    alert("Please enter a valid quantity.");
    return;
  }

  const existing = bill.find(b => b.id == item.id);
  if (existing) {
    existing.qty += qty;
  } else {
    bill.push({ ...item, qty });
  }

  document.getElementById("itemQty").value = "";
  renderBill();
}

function renderBill() {
  const list = document.getElementById("billItems");
  list.innerHTML = "";
  let total = 0;

  bill.forEach((b, i) => {
    const amount = b.qty * b.price;
    total += amount;
    const li = document.createElement("li");
    li.className = "flex justify-between items-center bg-gray-100 p-2 rounded";
    li.innerHTML = `
      <span>${b.name} Ã— ${b.qty}</span>
      <span class="flex space-x-3">
        <span>Rs.${amount.toFixed(2)}</span>
        <button onclick="removeItem(${i})" class="text-red-500 hover:underline print:hidden">Remove</button>
      </span>
    `;
    list.appendChild(li);
  });

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}

function removeItem(index) {
  bill.splice(index, 1);
  renderBill();
}

async function saveBill() {
  if (bill.length === 0) {
    alert("No items to save.");
    return;
  }

  const customerId = document.getElementById("customerSelect").value;
  const customer = customers.find(c => c.accountNumber == customerId);

  if (!customer) {
    alert("Select a valid customer.");
    return;
  }

  const totalAmount = bill.reduce((sum, item) => sum + (item.qty * item.price), 0);

  const payload = {
    accountNumber: customer.accountNumber,
    customerName: customer.name,  // Added customerName here
    totalAmount: totalAmount,
    items: bill.map(item => ({
      itemId: item.id,
      quantity: item.qty
    }))
  };

  try {
    const response = await fetch("http://localhost:8080/pahanaBackend/resources/bills", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if (response.ok) {
      alert("âœ… Bill saved successfully!");
      bill = [];
      renderBill();
    } else {
      alert("âŒ Failed to save bill.");
    }
  } catch (error) {
    console.error("Error saving bill:", error);
    alert("âŒ Error connecting to backend.");
  }
}



function printBill() {
  window.print();
}

function downloadPDF() {
  const section = document.getElementById("bill-section");
  const buttons = section.querySelectorAll("button");
  buttons.forEach(btn => btn.style.display = "none");

  html2pdf().from(section).set({
    margin: 0.5,
    filename: "pahana-bill.pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: "in", format: "letter", orientation: "portrait" }
  }).save().then(() => {
    buttons.forEach(btn => btn.style.display = "inline-block");
  });
}

window.onload = loadData;
</script>

</body>
</html>
