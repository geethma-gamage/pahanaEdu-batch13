<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pahana Edu - Generate Bill</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans">

<div class="max-w-2xl mx-auto bg-white rounded-lg shadow-md p-6" id="bill-section">
  <h1 class="text-2xl font-bold text-center mb-6">Generate Bill</h1>

  <!-- Customer Dropdown -->
  <div class="mb-4">
    <label class="font-semibold">Select Customer</label>
    <select id="customerSelect" class="w-full p-2 border rounded" onchange="updateCustomerDetails()"></select>
    <div id="customerDetails" class="text-sm text-gray-700 mt-2"></div>
  </div>

  <!-- Item Dropdown -->
  <div class="mb-4">
    <label class="font-semibold">Select Item</label>
    <div class="flex space-x-2">
      <select id="itemSelect" class="flex-grow p-2 border rounded" onchange="updateItemDetails()"></select>
      <input type="number" id="itemQty" placeholder="Qty" min="1" class="w-24 p-2 border rounded" />
      <button onclick="addItem()" class="bg-blue-500 text-white px-4 rounded">Add</button>
    </div>
    <div id="itemDetails" class="text-sm text-gray-700 mt-2"></div>
  </div>

  <!-- Items in Bill -->
  <div class="mb-4">
    <label class="font-semibold">Items in Bill</label>
    <ul id="billItems" class="border p-2 rounded mt-1 space-y-2"></ul>
  </div>

  <!-- Total -->
  <div class="text-right text-xl font-bold mb-4">
    Total: Rs. <span id="totalAmount">0.00</span>
  </div>

  <!-- Buttons -->
  <div class="flex space-x-4">
    <button onclick="saveBill()" class="bg-green-600 text-white px-4 py-2 rounded">Save Bill</button>
    <button onclick="printBill()" class="bg-gray-700 text-white px-4 py-2 rounded">Print</button>
  </div>
</div>

<script>
const API_CUSTOMERS = "http://localhost:8080/pahanaBackend/resources/customers";
const API_ITEMS = "http://localhost:8080/pahanaBackend/resources/items";

let customers = [];
let items = [];
let bill = [];

async function loadData() {
  customers = await fetch(API_CUSTOMERS).then(res => res.json());
  items = await fetch(API_ITEMS).then(res => res.json());

  const customerSelect = document.getElementById("customerSelect");
  const itemSelect = document.getElementById("itemSelect");

  customers.forEach(c => {
    const option = document.createElement("option");
    option.value = c.accountNumber;
    option.textContent = c.name;
    customerSelect.appendChild(option);
  });

  items.forEach(i => {
    const option = document.createElement("option");
    option.value = i.id;
    option.textContent = `${i.name} (Rs.${i.price})`;
    itemSelect.appendChild(option);
  });

  updateCustomerDetails();
  updateItemDetails();
}

function updateCustomerDetails() {
  const customer = customers.find(c => c.accountNumber == document.getElementById("customerSelect").value);
  if (customer) {
    document.getElementById("customerDetails").innerHTML = `
      <div>üìç Address: ${customer.address}</div>
      <div>üìû Phone: ${customer.telephone}</div>
      <div>üìß Email: ${customer.email}</div>
    `;
  }
}

function updateItemDetails() {
  const item = items.find(i => i.id == document.getElementById("itemSelect").value);
  if (item) {
    document.getElementById("itemDetails").innerHTML = `
      <div>üì¶ Category: ${item.category}</div>
      <div>üìã Available: ${item.quantity}</div>
    `;
  }
}

function addItem() {
  const itemId = document.getElementById("itemSelect").value;
  const quantity = parseInt(document.getElementById("itemQty").value);
  const item = items.find(i => i.id == itemId);

  if (!item || !quantity || quantity <= 0) {
    alert("Select valid item and quantity.");
    return;
  }

  const existing = bill.find(b => b.id == item.id);
  if (existing) {
    existing.qty += quantity;
  } else {
    bill.push({ ...item, qty: quantity });
  }

  document.getElementById("itemQty").value = "";
  renderBill();
}

function renderBill() {
  const list = document.getElementById("billItems");
  list.innerHTML = "";
  let total = 0;

  bill.forEach((b, index) => {
    const amount = b.qty * b.price;
    total += amount;

    const li = document.createElement("li");
    li.className = "flex justify-between items-center border p-2 rounded bg-gray-50";
    li.innerHTML = `
      <div>${b.name} x ${b.qty}</div>
      <div class="flex items-center space-x-4">
        <div>Rs.${amount.toFixed(2)}</div>
        <button onclick="removeItem(${index})" class="text-red-600 hover:underline print:hidden">Remove</button>
      </div>
    `;
    list.appendChild(li);
  });

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}

function removeItem(index) {
  bill.splice(index, 1);
  renderBill();
}

function saveBill() {
  if (bill.length === 0) {
    alert("No items to save.");
    return;
  }
  alert("Bill saved! (Backend integration needed)");
}

function printBill() {
  window.print();
}

window.onload = loadData;
</script>

<style>
@media print {
  body * {
    visibility: hidden;
  }
  #bill-section, #bill-section * {
    visibility: visible;
  }
  #bill-section {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
  }
  .print\:hidden {
    display: none !important;
  }
}
</style>

</body>
</html>
